name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      api: ${{ steps.projects.outputs.api }}
      platform: ${{ steps.projects.outputs.platform }}
      core: ${{ steps.projects.outputs.core }}
      ui: ${{ steps.projects.outputs.ui }}
      apps: ${{ steps.projects.outputs.apps }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: moonrepo/setup-toolchain@v0
        with:
          auto-setup: true

      - id: projects
        name: List affected projects
        run: |
          moon query projects --json > all.json
          moon query projects --affected --json > changed.json

          echo "api=$(jq -r '.projects | map(select(.id == "api")) | any | tostring' changed.json)" >> $GITHUB_OUTPUT
          echo "platform=$(jq -r '.projects | map(select(.id == "platform")) | any | tostring' changed.json)" >> $GITHUB_OUTPUT
          echo "core=$(jq -r '.projects | map(select(.id == "core")) | any | tostring' changed.json)" >> $GITHUB_OUTPUT
          echo "ui=$(jq -r '.projects | map(select(.id == "ui")) | any | tostring' changed.json)" >> $GITHUB_OUTPUT
          echo "apps=$(jq -r '[.projects[].id] | join(",")' changed.json)" >> $GITHUB_OUTPUT

          echo "All projects:"
          jq -r '.projects[].id' all.json
          echo ""
          echo "Changed projects:"
          jq -r '.projects[].id' changed.json

  api:
    name: API
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.api != ''
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - uses: moonrepo/setup-toolchain@v0
        with:
          auto-setup: true

      - run: moon run api:lint

      - name: Would deploy API
        run: echo "::notice title=Deployment::API app would be deployed"

  platform:
    name: Platform
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.platform != ''
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - uses: moonrepo/setup-toolchain@v0
        with:
          auto-setup: true

      - run: moon run platform:lint
      - run: moon run platform:build

      - name: Would deploy Platform
        run: echo "::notice title=Deployment::Platform app would be deployed"

  packages:
    name: Packages
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.core != '' || needs.detect-changes.outputs.ui != ''
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - uses: moonrepo/setup-toolchain@v0
        with:
          auto-setup: true

      - name: Lint affected packages
        run: |
          if [ "${{ needs.detect-changes.outputs.core }}" != "" ]; then
            moon run core:lint
          fi
          if [ "${{ needs.detect-changes.outputs.ui }}" != "" ]; then
            moon run ui:lint
          fi
