name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      api: ${{ steps.projects.outputs.api }}
      platform: ${{ steps.projects.outputs.platform }}
      core: ${{ steps.projects.outputs.core }}
      ui: ${{ steps.projects.outputs.ui }}
      apps: ${{ steps.projects.outputs.apps }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: moonrepo/setup-toolchain@v0
        with:
          auto-setup: true

      - id: projects
        name: List affected projects
        run: |
          ALL=$(moon query projects --json)
          CHANGED=$(moon query projects --affected --json)

          echo "api=$(echo "$CHANGED" | jq -r 'map(select(.id == "api")) | any' | head -c1)" >> $GITHUB_OUTPUT
          echo "platform=$(echo "$CHANGED" | jq -r 'map(select(.id == "platform")) | any' | head -c1)" >> $GITHUB_OUTPUT
          echo "core=$(echo "$CHANGED" | jq -r 'map(select(.id == "core")) | any' | head -c1)" >> $GITHUB_OUTPUT
          echo "ui=$(echo "$CHANGED" | jq -r 'map(select(.id == "ui")) | any' | head -c1)" >> $GITHUB_OUTPUT
          echo "apps=$(echo "$CHANGED" | jq -r '[.[].id] | join(",")')" >> $GITHUB_OUTPUT

          echo "All projects:"
          echo "$ALL" | jq -r '.[].id'
          echo ""
          echo "Changed projects:"
          echo "$CHANGED" | jq -r '.[].id'

  api:
    name: API
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.api != ''
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: moonrepo/setup-toolchain@v0
        with:
          auto-setup: true

      - run: moon run api:lint

      - name: Would deploy API
        run: echo "::notice title=Deployment::API app would be deployed"

  platform:
    name: Platform
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.platform != ''
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: moonrepo/setup-toolchain@v0
        with:
          auto-setup: true

      - run: moon run platform:lint
      - run: moon run platform:build

      - name: Would deploy Platform
        run: echo "::notice title=Deployment::Platform app would be deployed"

  packages:
    name: Packages
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.core != '' || needs.detect-changes.outputs.ui != ''
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: moonrepo/setup-toolchain@v0
        with:
          auto-setup: true

      - run: moon run core:lint
      - run: moon run ui:lint
